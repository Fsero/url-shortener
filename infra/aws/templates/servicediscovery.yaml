AWSTemplateFormatVersion: "2010-09-09"
Description: "AWS CloudFormation Service Discovery"
Parameters:
  Name:
    Description: "Student ID"
    Type: "String"
  VPC:
    Description: Choose which VPC this server should be deployed to
    Type: AWS::EC2::VPC::Id

Resources:
  PrivateNamespace:
    Type: "AWS::ServiceDiscovery::PrivateDnsNamespace"
    Properties:
      Description: !Join [ "", ["the urlshortener private namespace for ", !Ref Name]]
      Vpc: !Ref VPC
      Name: !Join [ "", [!Ref Name,".aws"]]
  ResolverService:
    Type: "AWS::ServiceDiscovery::Service"
    Properties:
      Description: !Join [ "", ["The resolver service for ", !Ref Name]]
      DnsConfig:
        DnsRecords:
          -
            Type: "SRV"
            TTL: "30"
        NamespaceId: !Ref PrivateNamespace
      Name: resolver
  ResolverServiceParameterStore:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !Join ["/",["",!Ref Name,"prod","resolver","service"]]
      Description: "Resolver service ID"
      Type: String
      Value: !Ref ResolverService
  ResolverServiceDNSParameterStore:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !Join ["/",["",!Ref Name,"prod","sd","resolver"]]
      Description: "Resolver service ID"
      Type: String
      Value: !Join ["",["resolver.",!Ref Name,".aws"]]
  ShortenerService:
    Type: "AWS::ServiceDiscovery::Service"
    Properties:
      Description: !Join [ "", ["The shortener service for ", !Ref Name]]
      DnsConfig:
        DnsRecords:
          -
            Type: "SRV"
            TTL: "30"
        NamespaceId: !Ref PrivateNamespace
      Name: shortener
  ShortenerServiceParameterStore:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !Join ["/",["",!Ref Name,"prod","shortener","service"]]
      Description: "Shortener service ID"
      Type: String
      Value: !Ref ShortenerService
  ShortenerServiceDNSParameterStore:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !Join ["/",["",!Ref Name,"prod","sd","shortener"]]
      Description: "Shortener service ID"
      Type: String
      Value: !Join ["",["shortener.",!Ref Name,".aws"]]

Outputs:
  ResolverServiceId:
    Description: "Resolver Service ID"
    Value: !Ref ResolverService
  ShortenerServiceId:
    Description: "Shortener Service ID"
    Value: !Ref ShortenerService
  NamespaceId:
    Description: "Namespace Service ID"
    Value: !Ref PrivateNamespace
